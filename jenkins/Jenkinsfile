pipeline {
    agent none

    environment {
        RUST_BACKTRACE = '1'
        CARGO_TERM_COLOR = 'always'
    }

    stages {
        stage('Backend') {
            agent {
                docker {
                    image 'rust:latest'
                    args '-v .:/workspace -v cargo-cache:/usr/local/cargo/registry'
                }
            }
            steps {
                sh '''
                    cd /workspace/backend
                    echo "ğŸ¦€ Running Rust tests..."
                    cargo test --no-fail-fast
                    echo "âœ… Tests passed"

                    echo "ğŸ”¨ Building release binary..."
                    cargo build --release
                    echo "âœ… Release build complete"
                '''
            }
        }

        stage('Frontend') {
            agent {
                docker {
                    image 'oven/bun:latest'
                    args '-v .:/workspace'
                }
            }
            steps {
                sh '''
                    cd /workspace/frontend
                    echo "ğŸ“¦ Installing dependencies..."
                    bun install

                    echo "ğŸ¨ Running tests..."
                    bun test
                    echo "âœ… Tests passed"

                    echo "ğŸ” Running type check..."
                    bun run check
                    echo "âœ… Type check passed"

                    echo "ğŸ”¨ Building production bundle..."
                    bun run build
                    echo "âœ… Production build complete"
                '''
            }
        }
    }

    post {
        success { echo 'ğŸ‰ Pipeline completed successfully!' }
        failure { echo 'âŒ Pipeline failed.' }
    }
}
